<UserControl
    x:Class="StrixMusic.Controls.ShellSettingsEditor"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:StrixMusic.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:controls="using:Microsoft.UI.Xaml.Controls"
    xmlns:ui="using:Microsoft.Toolkit.Uwp.UI"
    xmlns:strixMusic="using:StrixMusic"
    xmlns:converters="using:StrixMusic.Converters"
    xmlns:controls1="using:Microsoft.Toolkit.Uwp.UI.Controls"
    xmlns:core="using:Microsoft.Xaml.Interactions.Core"
    xmlns:interactivity="using:Microsoft.Xaml.Interactivity"
    xmlns:labs="using:CommunityToolkit.Labs.WinUI"
    xmlns:animatedVisuals="using:Microsoft.UI.Xaml.Controls.AnimatedVisuals"
    xmlns:appModels="using:StrixMusic.AppModels"
    xmlns:winUi="using:OwlCore.WinUI"
    xmlns:attached="using:OwlCore.WinUI.Attached"
    x:Name="RootControl">

    <UserControl.Resources>
        <converters:ShellEnumToDisplayNameConverter x:Key="ShellEnumToDisplayNameConverter" />
        <converters:ShellEnumToDescriptionConverter x:Key="ShellEnumToDescriptionConverter"/>

        <SetterBaseCollection x:Name="HideShellSizeIndicator">
            <!-- Hide shell size indicator -->
            <Setter Target="ShellPresenterViewbox.IsHitTestVisible" Value="False"/>
        </SetterBaseCollection>

        <SetterBaseCollection x:Name="DisableClickingShell">
            <!-- Disable clicking on shell -->
            <Setter Target="CurrentSizeText.Visibility" Value="Collapsed"/>
        </SetterBaseCollection>

        <SetterBaseCollection x:Name="ReducedPresenterPadding">
            <!-- Reduce presenter padding -->
            <Setter Target="ShellPreviewBorder.Padding" Value="20,0"/>
        </SetterBaseCollection>

        <SetterBaseCollection x:Name="ShellViewboxLeftOfShellDescriptor">
            <!-- Position shell descriptor on right column, making space for an icon or preview on left. -->
            <Setter Target="ShellDescriptorGrid.(Grid.Column)" Value="1"/>
            <Setter Target="ShellDescriptorGrid.(Grid.ColumnSpan)" Value="1"/>
            <Setter Target="ShellDescriptorGrid.(Grid.Row)" Value="0"/>
            <Setter Target="ShellDescriptorGrid.(Grid.RowSpan)" Value="2"/>

            <!-- Position Shell Viewbox to the left of the descriptor -->
            <Setter Target="ShellPresenterViewbox.(Grid.Column)" Value="0"/>
            <Setter Target="ShellPresenterViewbox.(Grid.ColumnSpan)" Value="1"/>
            <Setter Target="ShellPresenterViewbox.(Grid.Row)" Value="0"/>
            <Setter Target="ShellPresenterViewbox.(Grid.RowSpan)" Value="2"/>
            <Setter Target="ShellPresenterViewbox.MaxWidth" Value="150"/>
            <Setter Target="ShellPresenterViewbox.MaxHeight" Value="150"/>

            <!-- Change shell presenter to a reasonably small size -->
            <Setter Target="ShellPresenterContainer.Width" Value="1200"/>
            <Setter Target="ShellPresenterContainer.Height" Value="720"/>
        </SetterBaseCollection>

        <winUi:CompositeVisualStateSetter x:Name="ShortStateSetters">
            <StaticResource ResourceKey="HideShellSizeIndicator"/>
            <StaticResource ResourceKey="DisableClickingShell"/>
            <StaticResource ResourceKey="ReducedPresenterPadding"/>
            <StaticResource ResourceKey="ShellViewboxLeftOfShellDescriptor"/>
        </winUi:CompositeVisualStateSetter>
    </UserControl.Resources>

    <Grid x:Name="RootGrid">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup x:Name="WindowStates">

                <VisualState x:Name="ShortState" attached:CompositeVisualStateSetter.Setters="{StaticResource ShortStateSetters}">
                    <VisualState.StateTriggers>
                        <labs:ControlSizeTrigger TargetElement="{x:Bind RootControl}" 
                                                 MaxHeight="700"/>
                    </VisualState.StateTriggers>
                </VisualState>

            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>

        <Border x:Name="ShellPreviewBorder" MaxWidth="1000"
            Background="{ThemeResource SystemControlChromeMediumLowAcrylicElementMediumBrush}"
            BorderBrush="{ThemeResource SystemControlBackgroundBaseLowBrush}" BorderThickness="1"
            Margin="0,15,0,20" Padding="50,30">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <Grid x:Name="ShellDescriptorGrid" Grid.Row="0" Grid.ColumnSpan="2" VerticalAlignment="Center">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Row="0" Grid.Column="0" Visibility="{x:Bind ShellPresenter.IsPreferredShellActive, Mode=OneWay}"
                               TextWrapping="WrapWholeWords" HorizontalAlignment="Left" FontSize="20"
                               Text="{x:Bind ShellSettings.PreferredShell, Mode=OneWay, Converter={StaticResource ShellEnumToDisplayNameConverter}}"/>

                    <TextBlock Grid.Row="0" Grid.Column="0" Visibility="{x:Bind ShellPresenter.IsFallbackShellActive, Mode=OneWay}"
                               TextWrapping="WrapWholeWords" HorizontalAlignment="Left" FontSize="20"
                               Text="{x:Bind ShellSettings.FallbackShell, Mode=OneWay, Converter={StaticResource ShellEnumToDisplayNameConverter}}"/>

                    <TextBlock Grid.Row="1" Grid.Column="0" Visibility="{x:Bind ShellPresenter.IsPreferredShellActive, Mode=OneWay}"
                           TextWrapping="WrapWholeWords" HorizontalAlignment="Left" FontSize="14"
                           Text="{x:Bind ShellSettings.PreferredShell, Mode=OneWay, Converter={StaticResource ShellEnumToDescriptionConverter}}"/>

                    <TextBlock Grid.Row="1" Grid.Column="0" Visibility="{x:Bind ShellPresenter.IsFallbackShellActive, Mode=OneWay}"
                               TextWrapping="WrapWholeWords" HorizontalAlignment="Left" FontSize="14"
                               Text="{x:Bind ShellSettings.FallbackShell, Mode=OneWay, Converter={StaticResource ShellEnumToDescriptionConverter}}"/>

                    <TextBlock x:Name="CurrentSizeText" Grid.Row="1" Grid.Column="1" HorizontalAlignment="Right">
                        <Run Text="{Binding ElementName=ShellPresenterContainer, Path=Width}"/>
                        <Run Text="x"/>
                        <Run Text="{Binding ElementName=ShellPresenterContainer, Path=Height}"/>
                    </TextBlock>
                </Grid>

                <Viewbox x:Name="ShellPresenterViewbox" Stretch="Uniform" StretchDirection="Both" Margin="0,20,20,20"
                         Grid.Row="1" Grid.ColumnSpan="2">
                    <Border x:Name="ShellPresenterContainer"
                            Height="1080"
                            Width="1920">
                        <Grid BorderThickness="1" BorderBrush="{ThemeResource SystemControlBackgroundBaseLowBrush}">
                            <strixMusic:ShellPresenter x:Name="ShellPresenter"
                                                       PreferredShell="{x:Bind ShellSettings.PreferredShell, Mode=OneWay}"
                                                       FallbackShell="{x:Bind ShellSettings.FallbackShell}"
                                                       Root="{x:Bind Root, Mode=OneWay}"/>

                            <labs:PropertySizer HorizontalAlignment="Right"
                                            Width="35" Margin="0,0,-45,0" FontSize="25"
                                            Height="{Binding ElementName=ShellPresenterContainer, Path=Height}"
                                            Minimum="500"
                                            Maximum="5000"
                                            Binding="{x:Bind ShellPresenterContainer.Width, Mode=TwoWay}"/>

                            <labs:PropertySizer VerticalAlignment="Bottom"
                                            Orientation="Horizontal"
                                            Height="35" Margin="0,0,0,-45" FontSize="25"
                                            Width="{Binding ElementName=ShellPresenterContainer, Path=Width}"
                                            Minimum="250"
                                            Maximum="2000"
                                            Binding="{x:Bind ShellPresenterContainer.Height, Mode=TwoWay}"/>
                        </Grid>
                    </Border>
                </Viewbox>
            </Grid>
        </Border>

        <StackPanel Spacing="8" Grid.Row="1">
            <labs:SettingsCard Header="Preferred Skin"
                               HeaderIcon="{ui:FontIcon Glyph=&#xE2AC;}">
                <ComboBox SelectedItem="{x:Bind ShellSettings.PreferredShell, Mode=TwoWay}"
                          ItemsSource="{ui:EnumValues Type=appModels:StrixMusicShells}">
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Converter={StaticResource ShellEnumToDisplayNameConverter}}"/>
                        </DataTemplate>
                    </ComboBox.ItemTemplate>

                    <interactivity:Interaction.Behaviors>
                        <core:EventTriggerBehavior EventName="SelectionChanged">
                            <core:InvokeCommandAction Command="{x:Bind ShellSettings.SaveCommand, Mode=OneWay}" CommandParameter="{x:Null}"/>
                        </core:EventTriggerBehavior>
                    </interactivity:Interaction.Behaviors>
                </ComboBox>
            </labs:SettingsCard>

            <labs:SettingsCard Header="Fallback Skin" Visibility="{x:Bind IsAdaptiveShellToInvertedVisibility(ShellSettings.PreferredShell), Mode=OneWay}"
                               Description="The skin to used when the window size is unsupported by the Preferred Skin."
                               HeaderIcon="{ui:FontIcon Glyph=&#xE61F;}">
                <ComboBox SelectedItem="{x:Bind ShellSettings.FallbackShell, Mode=TwoWay}"
                      ItemsSource="{ui:EnumValues Type=appModels:AdaptiveShells}">
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Converter={StaticResource ShellEnumToDisplayNameConverter}}"/>
                        </DataTemplate>
                    </ComboBox.ItemTemplate>

                    <interactivity:Interaction.Behaviors>
                        <core:EventTriggerBehavior EventName="SelectionChanged">
                            <core:InvokeCommandAction Command="{x:Bind ShellSettings.SaveCommand, Mode=OneWay}" CommandParameter="{x:Null}" />
                        </core:EventTriggerBehavior>
                    </interactivity:Interaction.Behaviors>
                </ComboBox>
            </labs:SettingsCard>

            <labs:SettingsCard Header="Restore appearance defaults"
                            HeaderIcon="{ui:FontIcon Glyph=&#xE10E;}">
                <Button Content="Restore defaults" Command="{x:Bind ShellSettings.ResetAllSettingsCommand, Mode=OneWay}" CommandParameter="{x:Null}">
                    <interactivity:Interaction.Behaviors>
                        <core:EventTriggerBehavior EventName="Click">
                            <core:InvokeCommandAction Command="{x:Bind ShellSettings.SaveCommand, Mode=OneWay}" CommandParameter="{x:Null}" />
                        </core:EventTriggerBehavior>
                    </interactivity:Interaction.Behaviors>
                </Button>
            </labs:SettingsCard>

            <ProgressBar IsIndeterminate="True" Visibility="{x:Bind ShellSettings.SaveCommand.IsRunning, Mode=OneWay}" />
            <ProgressBar IsIndeterminate="True" Visibility="{x:Bind ShellSettings.LoadCommand.IsRunning, Mode=OneWay}"/>
        </StackPanel>
    </Grid>
</UserControl>
